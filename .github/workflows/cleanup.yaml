name: cleanup-registry
on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  delete-old-images:
    runs-on: docker
    env:
      FORGEJO_URL: https://forgejo.gitgud.zip
      OWNER: stasaberg
      KEEP: 7
    strategy:
      matrix:
        package:
          - my-stupid-website
          - my-stupid-website-terminal
          - radio-service
          - api-gateway-service
    steps:
      - name: Install jq
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            apt-get update
            apt-get install -y jq
          fi
      - name: Prune old tags
        env:
          PACKAGE: ${{ matrix.package }}
          TOKEN: ${{ secrets.FORGEJO_REGISTRY_PASSWORD }}
        run: |
          set -euo pipefail
          if [ -z "${TOKEN:-}" ]; then
            echo "FORGEJO_REGISTRY_PASSWORD secret is not set" >&2
            exit 1
          fi
          api="${FORGEJO_URL}/api/v1/packages/${OWNER}/container/${PACKAGE}"
          tags=$(curl -fsSL -H "Authorization: token ${TOKEN}" "${api}/tags?limit=200" | jq -r 'sort_by(.created_at) | reverse | .[].name')
          if [ -z "${tags}" ]; then
            echo "No tags found for ${PACKAGE}"
            exit 0
          fi
          kept=0
          for tag in ${tags}; do
            kept=$((kept+1))
            if [ "${kept}" -le "${KEEP}" ]; then
              echo "Keeping ${PACKAGE}:${tag}"
              continue
            fi
            echo "Deleting ${PACKAGE}:${tag}"
            curl -fsSL -X DELETE -H "Authorization: token ${TOKEN}" "${api}/tags/${tag}"
          done
