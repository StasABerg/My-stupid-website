name: trivy-scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '20 7 * * 2' 

permissions:
  contents: read
  security-events: write
env:
  TRIVY_IMAGE: aquasec/trivy:0.50.1
  TRIVY_CACHE_DIR: /tmp/trivy-cache

jobs:
  trivy:
    name: Trivy Repository Scan
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Trivy on source code
        run: |
          set -euo pipefail
          mkdir -p "${TRIVY_CACHE_DIR}"
          docker run --rm \
            -v "${TRIVY_CACHE_DIR}:/root/.cache/" \
            -v "${GITHUB_WORKSPACE}:/workspace" \
            "${TRIVY_IMAGE}" fs \
              --scanners vuln,misconfig,secret \
              --ignore-unfixed \
              --severity HIGH,CRITICAL \
              --format sarif \
              --output /workspace/trivy-results.sarif \
              /workspace

      - name: Upload results artifact
        if: ${{ always() && hashFiles('trivy-results.sarif') != '' }}
        uses: actions/upload-artifact@v5
        with:
          name: trivy-repository
          path: trivy-results.sarif
