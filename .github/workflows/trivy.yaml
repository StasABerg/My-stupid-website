name: trivy-scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '20 7 * * 2' 

permissions:
  contents: read
  security-events: write
env:
  TRIVY_IMAGE: aquasec/trivy:0.50.1
  TRIVY_CACHE_DIR: /tmp/trivy-cache

jobs:
  trivy:
    name: Trivy Repository Scan
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Trivy on source code
        id: scan
        run: |
          set -euo pipefail
          mkdir -p "${TRIVY_CACHE_DIR}"
          docker run --rm \
            -v "${TRIVY_CACHE_DIR}:/root/.cache/" \
            -v "${GITHUB_WORKSPACE}:/workspace" \
            "${TRIVY_IMAGE}" fs \
              --scanners vuln,misconfig,secret \
              --ignore-unfixed \
              --severity HIGH,CRITICAL \
              --format template \
              --template '{{- range . }}{{- if or .Vulnerabilities .Misconfigurations }}## {{ .Target }}\n{{- range .Vulnerabilities }}- {{ .Severity }} {{ .PkgName }} {{ .InstalledVersion }} -> {{ .FixedVersion }} ({{ .VulnerabilityID }})\n{{- end }}{{- range .Misconfigurations }}- {{ .Severity }} {{ .ID }}: {{ .Title }}\n{{- end }}{{- end }}{{- end }}' \
              --output /workspace/trivy-report.txt \
              /workspace

      - name: Check for findings
        id: findings
        run: |
          if [ -s trivy-report.txt ]; then
            echo "has_findings=true" >> "$GITHUB_OUTPUT"
          else
            echo "No HIGH/CRITICAL findings detected"
            rm -f trivy-report.txt
            echo "has_findings=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload report artifact
        if: ${{ steps.findings.outputs.has_findings == 'true' }}
        uses: actions/upload-artifact@v3
        with:
          name: trivy-repository
          path: trivy-report.txt

      - name: Notify Discord on findings
        if: ${{ steps.findings.outputs.has_findings == 'true' }}
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "${DISCORD_WEBHOOK}" ]; then
            echo "DISCORD_WEBHOOK_URL secret not set; skipping Discord alert"
            exit 0
          fi
          SUMMARY="Trivy Findings for ${GITHUB_REPOSITORY} (${GITHUB_REF_NAME})"
          LINK="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          REPORT=$(sed 's/"/\\"/g' trivy-report.txt | head -c 1900)
          curl -fsSL -H "Content-Type: application/json" \
            -d "{\"embeds\":[{\"title\":\"${SUMMARY}\",\"description\":\"Workflow run: ${LINK}\\n${REPORT}\",\"color\":15158332}]}" \
            "${DISCORD_WEBHOOK}"
