name: trivy-scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '20 7 * * 2' 

permissions:
  contents: read
  security-events: write
env:
  TRIVY_IMAGE: aquasec/trivy:0.50.1
  TRIVY_CACHE_DIR: /tmp/trivy-cache

jobs:
  trivy:
    name: Trivy Repository Scan
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Trivy on source code
        id: scan
        run: |
          set -euo pipefail
          mkdir -p "${TRIVY_CACHE_DIR}"
          docker run --rm \
            -v "${TRIVY_CACHE_DIR}:/root/.cache/" \
            -v "${GITHUB_WORKSPACE}:/workspace" \
            "${TRIVY_IMAGE}" fs \
              --scanners vuln,misconfig,secret \
              --ignore-unfixed \
              --severity HIGH,CRITICAL \
              --format template \
              --template '{{- range . }}{{- if or .Vulnerabilities .Misconfigurations }}## {{ .Target }}\n{{- range .Vulnerabilities }}- {{ .Severity }} {{ .PkgName }} {{ .InstalledVersion }} -> {{ .FixedVersion }} ({{ .VulnerabilityID }})\n{{- end }}{{- range .Misconfigurations }}- {{ .Severity }} {{ .ID }}: {{ .Title }}\n{{- end }}{{- end }}{{- end }}' \
              --output /workspace/trivy-report.txt \
              /workspace

      - name: Upload report artifact
        if: ${{ always() && hashFiles('trivy-report.txt') != '' }}
        uses: actions/upload-artifact@v3
        with:
          name: trivy-repository
          path: trivy-report.txt

      - name: Notify Discord
        if: ${{ always() && hashFiles('trivy-report.txt') != '' }}
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          STATUS: ${{ job.status }}
        run: |
          if [ -z "${DISCORD_WEBHOOK}" ]; then
            echo "DISCORD_WEBHOOK_URL secret not set; skipping Discord notification"
            exit 0
          fi
          case "${STATUS}" in
            success) COLOR=3066993 ;;
            failure) COLOR=15158332 ;;
            cancelled) COLOR=9807270 ;;
            *) COLOR=3447003 ;;
          esac
          SUMMARY="Trivy ${STATUS^} for ${GITHUB_REPOSITORY} (${GITHUB_REF_NAME})"
          DESCRIPTION="Workflow run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          REPORT="$(if [ -f trivy-report.txt ]; then sed 's/"/\\"/g' trivy-report.txt | head -c 1900; else echo 'No report generated.'; fi)"
          curl -fsSL -H "Content-Type: application/json" \
            -d "{\"embeds\":[{\"title\":\"${SUMMARY}\",\"description\":\"${DESCRIPTION}\\n${REPORT}\",\"color\":${COLOR}}]}" \
            "${DISCORD_WEBHOOK}"
